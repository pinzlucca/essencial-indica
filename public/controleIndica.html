<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controle de Indicações</title>
  <link rel="stylesheet" href="indicarForm.css">
</head>
<body>
  <header>
    <img src="/images/LOGO-BRANCO.png" alt="">
    <ul class="nav" id="nav">
      <li><a id="navlink" class="nav__link" target="_blank" href="vagas.html" rel="noopener noreferrer">VAGAS</a></li>
      <li><a id="navlink" href="#QUEMSOMOS" class="nav__link">QUEM SOMOS</a></li>
      <li><a id="navlink" href="#nossos-serviços" class="nav__link">NOSSOS SERVIÇOS</a></li>
      <li><a id="navlink" href="#solicite-orçamento" class="nav__link">SOLICITE UM ORÇAMENTO</a></li>
    </ul>

    <!-- MENU MOBILE -->
    <button type="button" id="menu">
      <span></span>
      <span></span>
      <span></span>
    </button>
  </header>

  <div class="indica-app">
    <h1 class="title-indica">Controle de Indicações</h1>
    <div class="links">
      <a href="indica.html" class="controle-link">VOLTAR</a>
      <a href="login.html" class="controle-link">FAZER LOGIN</a>
    </div>

    <table id="indicacoesTable">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Telefone</th>
          <th>Posto de Trabalho</th>
          <th>De Acordo</th>
          <th>Currículo</th>
          <th>Data de Envio</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <!-- As linhas serão inseridas aqui pelo JavaScript -->
      </tbody>
    </table>
  </div>

<script>
  async function fetchIndicacoes() {
    try {
      const response = await fetch('/indicacoes');
      const data = await response.json();
      const tableBody = document.querySelector("#indicacoesTable tbody");
      tableBody.innerHTML = "";

      data.forEach(item => {
        const tr = document.createElement('tr');

        ["nome", "telefone", "posto", "regras"].forEach(campo => {
          const td = document.createElement('td');
          td.textContent = campo === "regras" ? (item.regras ? "Sim" : "Não") : item[campo];
          tr.appendChild(td);
        });

        // Currículo
        const tdCurriculo = document.createElement('td');
        if (item.curriculo) {
          const a = document.createElement('a');
          a.href = `/download/${item._id}`;
          a.textContent = "Visualizar";
          a.target = "_blank";
          tdCurriculo.appendChild(a);
        } else {
          tdCurriculo.textContent = "Nenhum arquivo";
        }
        tr.appendChild(tdCurriculo);

        // Data de Envio
        const tdData = document.createElement('td');
        tdData.textContent = new Date(item.createdAt).toLocaleString();
        tr.appendChild(tdData);

        // Status
        const tdStatus = document.createElement('td');
        const select = document.createElement('select');
        ["Sem status", "Aprovado", "Reprovado"].forEach(opt => {
          const option = document.createElement('option');
          option.value = opt;
          option.textContent = opt;
          option.selected = item.status === opt;
          select.appendChild(option);
        });

        select.addEventListener("change", async () => {
          await fetch(`/indicacoes/${item._id}/status`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status: select.value })
          });
        });

        tdStatus.appendChild(select);
        tr.appendChild(tdStatus);

        // Botão de excluir
        const tdExcluir = document.createElement('td');
        const btnExcluir = document.createElement('button');
        btnExcluir.classList.add("btn-excluir");
        btnExcluir.textContent = "Excluir";
        btnExcluir.addEventListener("click", async () => {
          if (confirm("Tem certeza que deseja excluir esta indicação?")) {
            await fetch(`/indicacoes/${item._id}`, { method: "DELETE" });
            tr.remove();
          }
        });

        tdExcluir.appendChild(btnExcluir);
        tr.appendChild(tdExcluir);

        tableBody.appendChild(tr);
      });
    } catch (err) {
      console.error("Erro ao buscar indicações:", err);
    }
  }

  fetchIndicacoes();
</script>
</body>
</html>